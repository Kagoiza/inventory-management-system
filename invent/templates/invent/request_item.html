{# invent/templates/invent/request_item.html #}
{% extends "invent/requestor_dashboard.html" %}
{% load static %}

{% block title %}Request Item{% endblock %}

{% block main_content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4 greeting">Request Item</h2>

    {% if messages %}
        <div class="messages mb-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="card p-4 shadow-sm">
        <form method="post" id="itemRequestForm">
            {% csrf_token %}

            <div class="mb-3">
                <label for="{{ form.item.id_for_label }}" class="form-label">{{ form.item.label }}:</label>
                {{ form.item }}
                {% if form.item.errors %}
                    {% for error in form.item.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="mb-3">
                <p class="mb-1">Available: <span id="available_qty" class="fw-bold">--</span></p>
                <p>Condition: <span id="item_condition" class="fw-bold">--</span></p>
            </div>

            <div class="mb-3">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">{{ form.quantity.label }}:</label>
                {{ form.quantity }}
                {% if form.quantity.errors %}
                    {% for error in form.quantity.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.reason.id_for_label }}" class="form-label">{{ form.reason.label }}:</label>
                {{ form.reason }}
                {% if form.reason.errors %}
                    {% for error in form.reason.errors %}
                        <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>

            <button type="submit" class="btn btn-success" id="submitBtn">
                Submit Request
                <span class="spinner-border spinner-border-sm d-none ms-2" role="status" aria-hidden="true" id="submitSpinner"></span>
            </button>
        </form>
    </div>
</div>

<!-- Select2 Styles & Scripts -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemSelect = document.getElementById('{{ form.item.id_for_label }}');
        const availableQtySpan = document.getElementById('available_qty');
        const itemConditionSpan = document.getElementById('item_condition');
        const quantityInput = document.getElementById('{{ form.quantity.id_for_label }}');
        const itemDetails = JSON.parse('{{ available_inventory_json|escapejs }}');

        // Update item info
        function updateItemInfo() {
            const selectedItemId = $('#{{ form.item.id_for_label }}').val();
            const details = itemDetails.find(item => item.id == selectedItemId);

            if (details) {
                availableQtySpan.textContent = details.quantity_remaining;
                itemConditionSpan.textContent = details.condition;
                quantityInput.max = details.quantity_remaining;
            } else {
                availableQtySpan.textContent = '--';
                itemConditionSpan.textContent = '--';
                quantityInput.max = '';
                quantityInput.value = '';
            }
        }

        // Initialize Select2
        $('#{{ form.item.id_for_label }}').select2({
            placeholder: 'Select an item',
            width: '100%'
        });

        // Handle change in Select2 dropdown
        $('#{{ form.item.id_for_label }}').on('change', function () {
            updateItemInfo();
        });

        updateItemInfo(); // Load item info on page load

        // Prevent double submission
        const form = document.getElementById('itemRequestForm');
        const submitBtn = document.getElementById('submitBtn');
        const spinner = document.getElementById('submitSpinner');

        form.addEventListener('submit', function () {
            submitBtn.disabled = true;
            spinner.classList.remove('d-none');
        });
    });
</script>
{% endblock main_content %}
